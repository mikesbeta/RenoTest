<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RenovationRate - Real Market Prices for Home Projects</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #151b24;
            --bg-tertiary: #1f2937;
            --accent-primary: #10b981;
            --accent-secondary: #3b82f6;
            --accent-warning: #f59e0b;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border: #374151;
            --font-display: 'Syne', sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;
        }
        
        body {
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Animated gradient background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(16, 185, 129, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        header {
            padding: 2rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 3rem;
            animation: slideDown 0.6s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }
        
        .tagline {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .stats-row {
            display: flex;
            gap: 2rem;
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.7rem;
        }
        
        .stat-value {
            color: var(--accent-primary);
            font-weight: 500;
            font-size: 1.2rem;
        }
        
        /* Main layout */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            margin-bottom: 4rem;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            height: fit-content;
            position: sticky;
            top: 2rem;
        }
        
        .filter-section {
            margin-bottom: 2rem;
        }
        
        .filter-section:last-child {
            margin-bottom: 0;
        }
        
        .filter-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        select, input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: var(--font-display);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        select:hover, input:hover {
            border-color: var(--accent-primary);
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .btn {
            padding: 1rem 2rem;
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-family: var(--font-display);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            width: 100%;
        }
        
        .btn:hover {
            background: #0ea472;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            margin-top: 0.75rem;
        }
        
        .btn-secondary:hover {
            background: var(--border);
            box-shadow: 0 8px 20px rgba(255, 255, 255, 0.05);
        }
        
        /* Main content */
        .content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .card-meta {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Project cards grid */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .project-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .project-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }
        
        .project-card:hover::before {
            transform: scaleY(1);
        }
        
        .project-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        
        .project-stats {
            display: flex;
            justify-content: space-between;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .price-range {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-primary);
            font-family: var(--font-mono);
        }
        
        .price-range-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Chart container */
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 1rem;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 20, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 3rem;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-title {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .close-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: var(--border);
            transform: rotate(90deg);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .data-table {
            margin-top: 2rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }
        
        thead {
            background: var(--bg-tertiary);
        }
        
        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            border-bottom: 2px solid var(--border);
        }
        
        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        tr:hover {
            background: var(--bg-tertiary);
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .delete-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .empty-state-text {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        
        .empty-state-subtext {
            font-size: 0.95rem;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: relative;
                top: 0;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .stats-row {
                flex-direction: column;
                gap: 1rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 2rem;
            }
            
            .projects-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .flash-message {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--accent-primary);
            color: var(--bg-primary);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            animation: slideInRight 0.3s ease-out, slideOutRight 0.3s ease-in 2.7s;
            z-index: 2000;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>RenovationRate</h1>
                    <p class="tagline">Real market prices for home renovation projects</p>
                </div>
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-label">Total Quotes</span>
                        <span class="stat-value" id="totalQuotes">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Projects</span>
                        <span class="stat-value" id="totalProjects">50</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Locations</span>
                        <span class="stat-value" id="totalLocations">0</span>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="main-grid">
            <aside class="sidebar">
                <div class="filter-section">
                    <label class="filter-label">Location</label>
                    <select id="locationFilter">
                        <option value="">All Locations</option>
                    </select>
                </div>
                
                <div class="filter-section">
                    <label class="filter-label">Project Type</label>
                    <select id="projectFilter">
                        <option value="">All Projects</option>
                    </select>
                </div>
                
                <div class="filter-section">
                    <label class="filter-label">Date Range</label>
                    <select id="dateFilter">
                        <option value="all">All Time</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
                
                <button class="btn" onclick="openAddQuoteModal()">+ Add Quote</button>
                <button class="btn btn-secondary" onclick="openManageDataModal()">Manage Data</button>
                <button class="btn btn-secondary" onclick="document.getElementById('csvImport').click()">Import CSV</button>
                <input type="file" id="csvImport" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
            </aside>
            
            <main class="content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Project Price Ranges</h2>
                        <span class="card-meta" id="filteredCount">0 projects</span>
                    </div>
                    <div class="projects-grid" id="projectsGrid">
                        <!-- Projects will be inserted here -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Price Distribution</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Add Quote Modal -->
    <div id="addQuoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Quote</h2>
                <div class="close-btn" onclick="closeAddQuoteModal()">Ã—</div>
            </div>
            <form id="addQuoteForm" onsubmit="handleAddQuote(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Project Type</label>
                        <select id="quoteProject" required>
                            <option value="">Select project...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quote Amount ($)</label>
                        <input type="number" id="quoteAmount" required min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Location (City, State)</label>
                        <input type="text" id="quoteLocation" required placeholder="e.g., Austin, TX">
                    </div>
                    <div class="form-group">
                        <label>ZIP Code</label>
                        <input type="text" id="quoteZip" required pattern="[0-9]{5}" placeholder="12345">
                    </div>
                    <div class="form-group">
                        <label>Date Quoted</label>
                        <input type="date" id="quoteDate" required>
                    </div>
                    <div class="form-group">
                        <label>Contractor Name (Optional)</label>
                        <input type="text" id="quoteContractor" placeholder="Optional">
                    </div>
                    <div class="form-group full-width">
                        <label>Notes (Optional)</label>
                        <input type="text" id="quoteNotes" placeholder="Any additional details...">
                    </div>
                </div>
                <button type="submit" class="btn">Save Quote</button>
            </form>
        </div>
    </div>
    
    <!-- Manage Data Modal -->
    <div id="manageDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Manage Data</h2>
                <div class="close-btn" onclick="closeManageDataModal()">Ã—</div>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <button class="btn" onclick="exportToCSV()">ðŸ“¥ Export to CSV</button>
            </div>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Location</th>
                            <th>Price</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Project types - top 50 common home renovation projects
        const PROJECT_TYPES = [
            'Roof Replacement',
            'Kitchen Remodel',
            'Bathroom Remodel',
            'Flooring Installation (Hardwood)',
            'Flooring Installation (Tile)',
            'Flooring Installation (Carpet)',
            'Flooring Installation (Laminate)',
            'Interior Painting',
            'Exterior Painting',
            'Garage Door Replacement',
            'Garage Floor Resurfacing',
            'Window Replacement',
            'Siding Replacement',
            'Deck Construction',
            'Patio Installation',
            'Fence Installation',
            'HVAC System Replacement',
            'Water Heater Replacement',
            'Plumbing Repairs',
            'Electrical Rewiring',
            'Basement Finishing',
            'Attic Insulation',
            'Driveway Paving',
            'Landscaping',
            'Sprinkler System Installation',
            'Countertop Replacement (Granite)',
            'Countertop Replacement (Quartz)',
            'Cabinet Refacing',
            'Cabinet Replacement',
            'Backsplash Installation',
            'Shower/Tub Replacement',
            'Toilet Replacement',
            'Vanity Installation',
            'Door Replacement (Interior)',
            'Door Replacement (Exterior)',
            'Crown Molding Installation',
            'Baseboard Installation',
            'Drywall Repair',
            'Ceiling Repair',
            'Gutter Installation',
            'Chimney Repair',
            'Foundation Repair',
            'Waterproofing',
            'Solar Panel Installation',
            'Pool Installation',
            'Hot Tub Installation',
            'Home Addition',
            'Sunroom Addition',
            'Whole House Renovation',
            'Appliance Installation'
        ];
        
        // Initialize data storage
        let quotes = [];
        let chart = null;
        
        // Load data from storage on startup
        async function loadData() {
            try {
                const result = await window.storage.get('renovation-quotes');
                if (result && result.value) {
                    quotes = JSON.parse(result.value);
                }
            } catch (error) {
                console.log('No existing data found, starting fresh');
                quotes = [];
            }
            updateUI();
        }
        
        // Save data to storage
        async function saveData() {
            try {
                await window.storage.set('renovation-quotes', JSON.stringify(quotes));
            } catch (error) {
                console.error('Error saving data:', error);
                showFlashMessage('Error saving data', 'error');
            }
        }
        
        // Initialize UI
        function initializeUI() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quoteDate').value = today;
            
            // Populate project dropdowns
            const projectSelects = document.querySelectorAll('#quoteProject, #projectFilter');
            projectSelects.forEach(select => {
                if (select.id === 'quoteProject') {
                    select.innerHTML = '<option value="">Select project...</option>';
                } else {
                    select.innerHTML = '<option value="">All Projects</option>';
                }
                PROJECT_TYPES.sort().forEach(project => {
                    const option = document.createElement('option');
                    option.value = project;
                    option.textContent = project;
                    select.appendChild(option);
                });
            });
            
            // Add filter listeners
            document.getElementById('locationFilter').addEventListener('change', updateUI);
            document.getElementById('projectFilter').addEventListener('change', updateUI);
            document.getElementById('dateFilter').addEventListener('change', updateUI);
        }
        
        // Filter quotes based on current filter selections
        function getFilteredQuotes() {
            const locationFilter = document.getElementById('locationFilter').value;
            const projectFilter = document.getElementById('projectFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            let filtered = quotes;
            
            if (locationFilter) {
                filtered = filtered.filter(q => q.location === locationFilter);
            }
            
            if (projectFilter) {
                filtered = filtered.filter(q => q.project === projectFilter);
            }
            
            if (dateFilter !== 'all') {
                const daysAgo = parseInt(dateFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                filtered = filtered.filter(q => new Date(q.date) >= cutoffDate);
            }
            
            return filtered;
        }
        
        // Calculate statistics for a project
        function calculateProjectStats(projectQuotes) {
            if (projectQuotes.length === 0) return null;
            
            const prices = projectQuotes.map(q => q.amount).sort((a, b) => a - b);
            const min = prices[0];
            const max = prices[prices.length - 1];
            const avg = prices.reduce((sum, p) => sum + p, 0) / prices.length;
            
            return { min, max, avg, count: prices.length };
        }
        
        // Update entire UI
        function updateUI() {
            updateStats();
            updateLocationFilter();
            updateProjectsGrid();
            updateChart();
        }
        
        // Update header stats
        function updateStats() {
            const filtered = getFilteredQuotes();
            const uniqueLocations = new Set(quotes.map(q => q.location));
            
            document.getElementById('totalQuotes').textContent = quotes.length;
            document.getElementById('totalLocations').textContent = uniqueLocations.size;
        }
        
        // Update location filter dropdown
        function updateLocationFilter() {
            const uniqueLocations = [...new Set(quotes.map(q => q.location))].sort();
            const locationFilter = document.getElementById('locationFilter');
            const currentValue = locationFilter.value;
            
            locationFilter.innerHTML = '<option value="">All Locations</option>';
            uniqueLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            });
            
            locationFilter.value = currentValue;
        }
        
        // Update projects grid
        function updateProjectsGrid() {
            const filtered = getFilteredQuotes();
            const projectsGrid = document.getElementById('projectsGrid');
            
            // Group quotes by project
            const projectGroups = {};
            filtered.forEach(quote => {
                if (!projectGroups[quote.project]) {
                    projectGroups[quote.project] = [];
                }
                projectGroups[quote.project].push(quote);
            });
            
            // Calculate stats for each project
            const projectStats = Object.entries(projectGroups)
                .map(([project, quotes]) => ({
                    project,
                    ...calculateProjectStats(quotes)
                }))
                .sort((a, b) => b.count - a.count);
            
            document.getElementById('filteredCount').textContent = 
                `${projectStats.length} project${projectStats.length !== 1 ? 's' : ''}`;
            
            if (projectStats.length === 0) {
                projectsGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">ðŸ“Š</div>
                        <div class="empty-state-text">No data yet</div>
                        <div class="empty-state-subtext">Add your first quote to get started</div>
                    </div>
                `;
                return;
            }
            
            projectsGrid.innerHTML = projectStats.map(stat => `
                <div class="project-card">
                    <div class="project-name">${stat.project}</div>
                    <div class="project-stats">
                        <span>${stat.count} quote${stat.count !== 1 ? 's' : ''}</span>
                        <span>Avg: $${stat.avg.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
                    </div>
                    <div class="price-range">
                        $${stat.min.toLocaleString('en-US', { maximumFractionDigits: 0 })} - $${stat.max.toLocaleString('en-US', { maximumFractionDigits: 0 })}
                    </div>
                    <div class="price-range-label">Price Range</div>
                </div>
            `).join('');
        }
        
        // Update chart
        function updateChart() {
            const filtered = getFilteredQuotes();
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Group quotes by project and calculate averages
            const projectGroups = {};
            filtered.forEach(quote => {
                if (!projectGroups[quote.project]) {
                    projectGroups[quote.project] = [];
                }
                projectGroups[quote.project].push(quote);
            });
            
            const chartData = Object.entries(projectGroups)
                .map(([project, quotes]) => ({
                    project,
                    ...calculateProjectStats(quotes)
                }))
                .sort((a, b) => b.avg - a.avg)
                .slice(0, 15); // Top 15 projects
            
            if (chart) {
                chart.destroy();
            }
            
            if (chartData.length === 0) {
                return;
            }
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.project),
                    datasets: [{
                        label: 'Average Price',
                        data: chartData.map(d => d.avg),
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US');
                                },
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(55, 65, 81, 0.5)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Modal functions
        function openAddQuoteModal() {
            document.getElementById('addQuoteModal').classList.add('active');
        }
        
        function closeAddQuoteModal() {
            document.getElementById('addQuoteModal').classList.remove('active');
            document.getElementById('addQuoteForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quoteDate').value = today;
        }
        
        function openManageDataModal() {
            updateDataTable();
            document.getElementById('manageDataModal').classList.add('active');
        }
        
        function closeManageDataModal() {
            document.getElementById('manageDataModal').classList.remove('active');
        }
        
        // Update data management table
        function updateDataTable() {
            const tbody = document.getElementById('dataTableBody');
            
            if (quotes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            No quotes added yet
                        </td>
                    </tr>
                `;
                return;
            }
            
            const sortedQuotes = [...quotes].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedQuotes.map((quote, index) => `
                <tr>
                    <td>${quote.project}</td>
                    <td>${quote.location}</td>
                    <td>$${quote.amount.toLocaleString('en-US')}</td>
                    <td>${new Date(quote.date).toLocaleDateString()}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteQuote(${quotes.indexOf(quote)})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Handle form submission
        async function handleAddQuote(event) {
            event.preventDefault();
            
            const quote = {
                project: document.getElementById('quoteProject').value,
                amount: parseFloat(document.getElementById('quoteAmount').value),
                location: document.getElementById('quoteLocation').value,
                zip: document.getElementById('quoteZip').value,
                date: document.getElementById('quoteDate').value,
                contractor: document.getElementById('quoteContractor').value,
                notes: document.getElementById('quoteNotes').value,
                id: Date.now()
            };
            
            quotes.push(quote);
            await saveData();
            updateUI();
            closeAddQuoteModal();
            showFlashMessage('Quote added successfully!');
        }
        
        // Delete quote
        async function deleteQuote(index) {
            if (confirm('Are you sure you want to delete this quote?')) {
                quotes.splice(index, 1);
                await saveData();
                updateUI();
                updateDataTable();
                showFlashMessage('Quote deleted');
            }
        }
        
        // Flash message
        function showFlashMessage(message) {
            const flash = document.createElement('div');
            flash.className = 'flash-message';
            flash.textContent = message;
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 3000);
        }
        
        // Handle CSV import
        async function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const newQuotes = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].split(',').map(v => v.trim());
                    const quote = {
                        project: values[0],
                        amount: parseFloat(values[1]),
                        location: values[2],
                        zip: values[3],
                        date: values[4],
                        contractor: values[5] || '',
                        notes: values[6] || '',
                        id: Date.now() + i
                    };
                    
                    if (quote.project && quote.amount && quote.location) {
                        newQuotes.push(quote);
                    }
                }
                
                quotes.push(...newQuotes);
                await saveData();
                updateUI();
                showFlashMessage(`Imported ${newQuotes.length} quotes!`);
                
                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }
        
        // Export data to CSV
        function exportToCSV() {
            if (quotes.length === 0) {
                showFlashMessage('No data to export');
                return;
            }
            
            const headers = ['Project', 'Amount', 'Location', 'ZIP', 'Date', 'Contractor', 'Notes'];
            const rows = quotes.map(q => [
                q.project,
                q.amount,
                q.location,
                q.zip,
                q.date,
                q.contractor || '',
                q.notes || ''
            ]);
            
            const csv = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `renovation-quotes-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            showFlashMessage('Data exported!');
        }
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
        
        // Initialize app
        initializeUI();
        loadData();
    </script>
</body>
</html>
